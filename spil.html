<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Vagtcentral Spil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        :root {
            --bg: #f5f5f5;
            --panel: #ffffff;
            --border: #ccc;
            --text: #222;
            --button-bg: #ffffff;
            --button-hover: #f0f0f0;
            --button-border: #ccc;
        }
        body.dark {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #444;
            --text: #f0f0f0;
            --button-bg: #2a2a2a;
            --button-hover: #333;
            --button-border: #555;
        }
        #map {
            height: 90vh;
            width: 100%;
        }
        #controls {
            padding: 12px;
            background: var(--panel);
            color: var(--text);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            position: relative;
        }
        button, select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover, select:hover {
            background: var(--button-hover);
        }
        #k√∏ret√∏jsPanel, #statusPanel, #logPanel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: var(--panel);
            padding: 14px;
            border-radius: 10px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: none;
            z-index: 1002;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .station-ikon {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            color: var(--text);
            display: inline-block;
        }
        .blink-lampe {
            width: 14px;
            height: 14px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin: auto;
            box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
        }
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
            }
            50% {
                opacity: 0.2;
                box-shadow: 0 0 2px 1px rgba(255, 0, 0, 0.2);
            }
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="aktiverStationsTilstand()">‚ûï Tilf√∏j Station</button>
        <button onclick="visK√∏ret√∏jsPanel()">üö® Alarmer k√∏ret√∏j</button>
        <button onclick="visStatusPanel()">üìã Status</button>
        <button onclick="toggleStationer()">üè¢ Vis/Skjul stationer</button>
        <button onclick="toggleTema()">üåì Skift tema</button>
        <label for="intervalV√¶lger">‚è±Ô∏è Alarm-interval:</label>
        <select id="intervalV√¶lger" onchange="opdaterAlarmInterval()">
            <option value="60000">1 minut</option>
            <option value="120000" selected>2 minutter</option>
            <option value="300000">5 minutter</option>
            <option value="600000">10 minutter</option>
            <option value="5000">5 sekunder</option>
        </select>
    </div>
    <div id="map"></div>
    <div id="k√∏ret√∏jsPanel"></div>
    <div id="statusPanel"></div>
    <div id="logPanel"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script>
        const map = L.map('map').setView([55.6761, 12.5683], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let stationer = [], alarmer = [], valgteK√∏ret√∏jer = [], stationsTilstand = false;
        const alarmTyper = [
            "Bygningsbrand (Villa/R√¶kkehus)", "Skovbrand", "Affaldsbrand", "Industri- og fabriksbrand", "Brand i erhvervsbygning",
            "Fritst√•ende bygning ‚Äì brand", "Brand i k√¶lder", "Bilbrand", "Brand i container", "Brand i maskinhus", "Elbrand", 
            "Brand i affaldscontainer", "Brand p√• tag", "Brand i skur", "Hedebrand", "Brand i stald", "Brand i landbrugsbygning", 
            "Brand i campingvogn", "Brand i b√•d", "Brand p√• vej", "Gaseksplosion", "Brand i traktor", "Brand i tog", 
            "Eksplosion i industri", "Brand p√• fabrik", "Brand p√• containerterminal", "Brand i motorcykel", "Menneskelig fejl ved brand", 
            "Brand i silo", "Brand p√• parkeringsplads", "Brand i t√∏mmerlager", "Brand i offentligt toilet", "Brand i lejlighed", 
            "Brand i restaurant", "Brand p√• byggeplads", "Brand i h√∏jhus", "Brand p√• lufthavn", "Brand p√• skib", "Brand i gasv√¶rk", 
            "Brand i gr√¶smark", "Brand i industribygning", "Brand i fjernvarme", "Brand i teknikrum", "Brand p√• station", 
            "Brand p√• rasteplads", "Brand i h√∏jhus", "Brand i stuehus", "Brand i lastbil", "Brand i maskinerum", "Brand p√• motorvej", 
            "Brand i telefonkiosk", "Brand i containerpark", "Brud p√• gasledning", "Brand i skovrydning", "Brand i trafikskilt", 
            "Brand i havn", "Brand i betongulv", "Brand p√• helikopter", "Brand i samlingshus", "Brand i daginstitution", 
            "Brand p√• rasteplads", "Brand i skolebygning", "Brand i el-tavle", "Brand p√• sportshal", "Brand i kulturhus", 
            "Brand i brokonstruktion", "Brand i brohus", "Brand i transformerstation", "Brand i stengr√• omr√•de", "Brand i lysmast", 
            "Brand i bunker", "Brand i butikslager", "Brand i underjordisk garage", "Brand p√• autobahn", "Brand p√• affaldsplads", 
            "Brand p√• loft", "Brand i bunker", "Brand p√• tankstation", "Brand p√• arbejdsplads", "Brand i bygning med kemikalier", 
            "Brand p√• fritidshusomr√•de", "Brand i skovomr√•de", "Brand i industrik√∏kken", "Brand i brandstation", "Brand i jernbaneoversk√¶ring", 
            "Brand i v√¶rksted", "Brand i bygningskonstruktion", "Brand i vejledningstelt", "Brand i industripark", "Brand p√• metrostation", 
            "Brand p√• lufthavnsomr√•de", "Brand i kraftv√¶rk", "Brand i affaldsdepot", "Brand i cykelskure", "Brand i containerby", 
            "Brand p√• flisearbejde", "Brand i maritimt omr√•de", "Brand i psykiatrisk afdeling", "Brand i dyrepark", "Brand i kemisk lager", 
            "Ambulanceudkald", "Hjertestop", "Hjerneskader", "Hovedtraume", "Trafikulykke", "Faldulykke", "Kv√¶lning", "Forgiftning", 
            "√Öndedr√¶tsbesv√¶r", "Svimmelhed/Bevidstl√∏shed", "Akut mavesmerter", "Allergisk reaktion", "Astmaanfald", "Hjerteanfald", 
            "Bl√∏dning ‚Äì ekstern", "Komplikation ved f√∏dsel", "B√∏rneulykke", "B√∏rneskader", "V√¶sketab (dehydrering)", 
            "Diabetesrelateret n√∏dsituation", "Epileptisk anfald", "T√•geh√¶mning (hjernebl√∏dning)", "Slagtilf√¶lde", 
            "Ulykke p√• arbejdspladsen", "V√•d ulykke (vandskader)", "L√∏bende feber", "Hjertel√∏s genoplivning", 
            "Almindelig skader i hjemmet", "Overdosis", "Graviditetsrelateret n√∏dsituation", "Pludselig feberkrampe", 
            "Hjerteproblemer", "H√∏j feber hos sp√¶dbarn", "Akut rygsmerte", "Ulykke med brud", "Miste bevidsthed", 
            "Akut sygdom ‚Äì uspecificeret", "B√∏rnef√∏dselsproblemer", "Synkope (pludselig besvimelse)", "√òdelagt led (f.eks. skulder, albue)", 
            "Amputation", "Alvorlig forbr√¶nding", "Bidskader", "Dyb stikskade", "Graviditet og f√∏dsel", "Smerter i brystet", 
            "Bevidstl√∏shed efter st√∏d", "Trafikuheld med personskader", "B√∏rneekstremforgiftning", "Blindtarmsbet√¶ndelse", 
            "√òdelagte organer (f.eks. indre organer)", "Overophedning (hedeb√∏lge)", "Feberanfald", "Koldbrand", "Ven√∏s trombose", 
            "Bevidstl√∏shed ved fald", "K√∏rsel af fejlinformation", "Hjernekrise", "Sv√¶r dehydrering", "Forstoppelse", 
            "Ortop√¶disk skade", "Behandling af s√•rinfektion", "Blodprop i lungerne", "Sv√¶rt √•ndedr√¶tsbesv√¶r", "Hjernemisdannelse", 
            "Smerter i k√¶ben", "Lammelse", "Fysiologisk chok", "Blod i opkast", "Bl√∏dning i munden", "Ulykke med elektrisk st√∏d", 
            "Fejlbehandling ved pilleindtag", "Uventet f√∏dsel", "Urinvejsinfektion", "√òdelagt l√•rben", "Kr√¶ftrelateret n√∏d", 
            "√òdelagt rygs√∏jle", "√òdelagt h√•ndled", "Hjernerystelse", "Akut lungebet√¶ndelse", "Alvorlig bet√¶ndelse", 
            "Politiudkald", "R√∏veri", "Indbrud", "Overfald", "Vold", "Vandalism", "Tyveri", "Biltyveri", "Indbrud i butik", 
            "Maskeret forbrydelse", "Ulykke med alvorlig personskade", "Voldt√¶gt", "Trafikulykke (drab, mist√¶nkeligt)", 
            "Bombetrussel", "Husr√∏veri", "K√∏rsel under p√•virkning", "K√∏rsel uden f√∏rerret", "Hjemmeinvasion", "Narkotikahandel", 
            "Tyveri fra butik", "Mist√¶nkelig aktivitet", "Brandstiftelse", "H√¶rv√¶rk", "Trafikkontroller", 
            "H√•ndtering af psykisk syg person", "Personer p√• flugt", "Forbrydelse i offentlig transport", 
            "Larm fra offentlige omr√•der", "Misbrug af v√•ben", "L√•st d√∏r eller sikkerhedsl√•s", "Ulovlig samling", 
            "Uroligheder i offentlig transport", "Mist√¶nkt iakttagelse af forbrydelse", "Angreb p√• offentlig ansatte", 
            "Misbrug af alkohol", "Trusselsituation", "Smugling af varer", "Svindel med penge", "Ulovlig parkering", 
            "Misbrug af offentlig orden", "Varmgang p√• arbejdspladsen", "Ulykke ved offentlig institution", 
            "Elektronisk tyveri", "Overv√•gning af mist√¶nkte", "Hvidvaskning af penge", "Spionage", 
            "Kriminalitet i offentlig transport", "Misbrug af midler", "Vold i skoler og institutioner", 
            "Trusler mod ansatte", "Uro i boligomr√•de", "H√¶rv√¶rk p√• offentlig bygning", "Sabotage", 
            "Organiseret kriminalitet", "Bilbr√¶nding", "Ulovlige demonstrationer", "Indbrud i k√∏ret√∏j", 
            "Mist√¶nkeligt udenlandsk k√∏b", "Fors√∏g p√• vold", "Uorden p√• offentlige steder", "Ulovlig indrejse", 
            "Svindel i bankforretninger", "Forbrydelse p√• arbejdspladsen", "Blokering af vej", 
            "Kriminalitet i sportsarena", "Forbrydelse under festival", "Razzia i virksomhed", "Brud p√• brandregler", 
            "Stj√•lne identiteter", "Ulovlig reklameplacering", "Organiseret r√∏veri", "Stj√•let k√∏ret√∏j i aktivitet", 
            "Skovtyveri", "S√∏mand p√• flugt", "Forbrydelse i supermarked", "Manipulation af politisk system", 
            "Misbrug af medier", "K√∏nsbaseret vold", "Misbrug af magtposition", "Cyberkriminalitet", 
            "√òdel√¶ggelse af offentlige optegnelser", "Bilnedbrud", "Fladt d√¶k", "Ulykke med personskader", 
            "Ulykke uden personskader", "Bilbr√¶nding (p√• vej)", "Overophedning af motor", "Benzinmangel", 
            "Starthj√¶lp (batteriudladning)", "Motorstop", "Vejsp√¶rring", "Vejrforhold (snestorm, isglatte veje)", 
            "K√∏ret√∏j sidder fast i sne", "K√¶dedyseproblemer (tuning motor)", "Pumpefejl (br√¶ndstofpumpe)", 
            "K√∏rsel uden f√∏rerret", "Mistet biln√∏gle", "K√∏ret√∏j ude af kontrol", "Fejl p√• bilens bremser", 
            "Afl√¶sning af bilens batteristatus", "Bil p√• sidevej (ikke tilkaldt politi)", "Bil p√• forkert vej", 
            "Elbil med lav batteri (kan ikke komme videre)", "K√∏ret√∏j p√• landevej (h√¶mmer trafik)", 
            "Udskiftning af lysp√¶re", "Reparation af bilens motor", "Ulykkestilf√¶lde med flere k√∏ret√∏jer", 
            "H√•ndtering af parkeret k√∏ret√∏j p√• ulovlig plads", "K√∏ret√∏j fast i mudder", "K√∏ret√∏j fast i vand (flod, regn)", 
            "K√∏ret√∏j fast i sand", "Vejhj√¶lp med lastbil", "Tjek af d√¶ktryk", "Sp√¶rret k√∏rsel (vejarbejde)", 
            "Vejhj√¶lp p√• motorvej", "K√∏rsel uden bilforsikring", "Skader p√• bilens st√∏dd√¶mper", 
            "Reparation af bilens elektriske system", "H√•ndtering af kemikalieudslip", "Vejhj√¶lp til p√•k√∏rt k√∏ret√∏j", 
            "Hjulskift ved vejkant", "Reparation af bilens aircondition", "K√∏rsel med mist√¶nkt motorst√∏j", 
            "Fejl p√• bilens gearkasse", "Reparation af forlygte", "Br√¶ndstofpumpefejl", "K√∏ret√∏j l√•st (sammenbrudt l√•sesystem)", 
            "H√•ndtering af udslip af v√¶sker fra k√∏ret√∏j", "Vejhj√¶lp til k√∏ret√∏j med mistet k√∏rekort", 
            "Udfordringer med bilens udst√∏dning", "Defekt bilvinduesvisker", "Problemer med bilens klimaanl√¶g", 
            "Vejhj√¶lp med lastbil p√• sidevej", "Ulykkesbilen p√• hovedvej", "Skader p√• bilens undercarriage", 
            "Nedbrudt k√∏ret√∏j ved jernbaneoverk√∏rsel", "Bilproblemer i t√¶t t√•ge", "K√∏ret√∏j med h√¶mmet motorfunktion", 
            "Ulykkesbil med v√¶ltning", "Vejhj√¶lp med k√∏ret√∏j p√• bakketop", "Faldende temperaturer ‚Äì frostfare", 
            "K√∏ret√∏j p√• sneglat vej", "Vejhj√¶lp til k√∏ret√∏j p√• grusvej", "K√∏ret√∏j med for h√∏j hastighed i d√•rligt vejr", 
            "Hjulskift p√• landvej", "Stoppet k√∏ret√∏j i midterrabatten", "K√∏ret√∏j p√• bro (problemer ved konstruktion)", 
            "K√∏rsel med for tung last", "Skader p√• k√∏ret√∏jets ledningssystem", "K√∏ret√∏j fast p√• bakketop", 
            "H√•ndtering af opst√•et gasl√¶kage i k√∏ret√∏j", "Problemer med bilens affjedring", "K√∏ret√∏j ude af vejbanen i sving", 
            "Vejhj√¶lp til k√∏ret√∏j p√• glat vej", "Mangel p√• bremsesystem i bil", "Ulykkesbil, som er blevet p√•k√∏rt bagfra", 
            "K√∏ret√∏j med problemer med motorens k√∏lesystem", "Skader p√• bilens karrosseri", "Fejl i bilens elektriske forbindelser", 
            "K√∏ret√∏j med defekte bremseklodser", "Skader p√• k√∏ret√∏jets hjuloph√¶ng", "Stoppet k√∏ret√∏j med motorlugt", 
            "K√∏ret√∏j med fejl i gearsystemet", "Vejhj√¶lp til k√∏ret√∏j, der mister olie", "Vejhj√¶lp til k√∏ret√∏j med defekte t√¶ndr√∏r", 
            "K√∏ret√∏j p√• v√¶ltet bro", "K√∏ret√∏j fast i mudder og vand", "Bil p√• udkig efter tankstation", 
            "Vejhj√¶lp til defekte lygter", "K√∏rsel med mistet forrude", "H√•ndtering af ukendt v√¶ske p√• vej", 
            "Ulykke med knust d√¶k", "Stoppet k√∏ret√∏j p√• vej med h√∏j hastighed", "Reparation af bilens klimaanl√¶g", 
            "Problemer med bilens vejhjul", "Vejhj√¶lp til lastbil i kold temperatur", "Vejhj√¶lp ved landskabsopgradering", 
            "K√∏ret√∏j med kn√¶kket aksel", "Reparation af bilens startmotor", "K√∏ret√∏j p√• forladt vej", "Hjulskift p√• lastbil", 
            "K√∏ret√∏j fast p√• motorvej", "Reparation af br√¶ndstofpumpen", "Ulykkesbil p√• motorvej", "K√∏ret√∏j fast i t√¶t trafik", 
            "Hjulproblemer p√• vej mod servicecenter", "Vejhj√¶lp p√• landevej", "Fejl p√• bilens styresystem", 
            "K√∏ret√∏j skadet under hastig opbremsning", "K√∏ret√∏j med ut√¶t kobling", "K√∏ret√∏j k√∏rer uden tilstr√¶kkelig olie", 
            "Problemer med bilens dyse", "K√∏ret√∏j fast i sandbanke", "Motorbr√¶nding og udfald", "Vejhj√¶lp til uheldig bil i regnvejr", 
            "Stoppet k√∏ret√∏j i vejsideh√∏jde", "Reparation af bilens motorventilator", "Fastk√∏rt k√∏ret√∏j med k√∏lesystemfejl", 
            "K√∏ret√∏j, der er parkeret ulovligt", "Vejhj√¶lp til k√∏ret√∏j med skader p√• vejen", "Bil med driftsforstyrrelser", 
            "Spr√¶ngt vandledning", "Str√∏msvigt i boligblok", "Manglende varmeforsyning", "Sprunget fjernvarmer√∏r", "L√¶k i gasledning", 
            "Vandtryk for lavt", "Alarm fra kloakpumpestation", "Defekt gadelygte", "Afbrudt internettjeneste", 
            "Signalfejl i trafikstyring", "Udstyr til fjernvarme svigter", "Driftsforstyrrelser p√• renseanl√¶g", 
            "Vandpr√∏ve ikke godkendt", "L√¶kage fra spildevandsledning", "Akut problemer med gadelys", 
            "Hj√¶lp til hjemmepleje borger", "Alarm fra n√∏dkald", "Person faldet i hjemmet", "Mistanke om sygdom hos borger", 
            "Mistanke om overgreb", "Vold mod personale", "Psykisk ustabil borger forsvundet", "Defekt d√∏r til kommunal bygning", 
            "Vandindtr√¶ngning i k√¶lder", "Skader p√• skolemur", "Manglende varme i daginstitution", "Elevator ude af drift", 
            "Skader p√• tag/tagrender", "Graffiti p√• skoler", "Vandl√¶kage i idr√¶tshal", "L√•st n√∏dudgang", 
            "Skimmelsvamp i offentlig bygning", "Brandslukningsudstyr mangler", "H√¶rv√¶rk p√• toiletbygning i park", 
            "Problemer med offentlige toiletter", "Manglende adgang til sportshal", "Defekt elevator i √¶ldrebolig", 
            "Skadedyrsangreb i institution", "Skadedyr registreret (rotter/myrer/duer)", "Frostskade p√• vandr√∏r", 
            "Overv√•gning: uautoriseret adgang til teknisk rum", "Nedbrudt automatiske d√∏re", "Overophedning af serverrum", 
            "Defekt klimaanl√¶g", "El-tavle fejl", "St√∏j fra ventilationsanl√¶g", "Nedbrudt ventilationsanl√¶g", 
            "For h√∏jt vandstand i k√¶lder", "Ulovlig affaldsdeponering", "D√∏de dyr i naturen", "Forurening af s√∏/vandl√∏b", 
            "Manglende t√∏mning af skraldespande i park", "Nedfaldne grene i anl√¶g", "Spr√∏jtegiftspild", "R√∏g/brand i naturomr√•de", 
            "Overfyldt container", "Graffiti p√• offentlige arealer", "Oversv√∏mmelse af rekreativt omr√•de", 
            "Giftig algeblomst i s√∏", "Kemikalieudslip fra virksomhed", "Oliet√∏nde i √•", "Invasiv art observeret", 
            "Skovsvampe p√• offentligt omr√•de", "Hul i vejbanen", "L√∏se fliser p√• fortov", "Nedfalden vejskilt", 
            "Vejbump beskadiget", "Skiltning mangler", "Vejskader efter frost", "Oversv√∏mmelse af vej", 
            "Defekt gadelys", "Trafiklys ude af drift", "Manglende saltning/rydning", "Tr√¶ eller gren sp√¶rrer vej", 
            "Manglende snerydning", "Olie-/kemikalieudslip p√• vej", "Vejarbejde ikke afm√¶rket", "H√¶rv√¶rk p√• busstoppested", 
            "Glas p√• cykelsti", "Cykelstativer v√¶ltet", "Manglende affaldsopsamling ved vej", "Skade p√• rabat", 
            "Fejlmeldt gadebelysning", "T√•ge p√• hovedvej", "Trafikprop pga. vejarbejde", "Defekt vejsp√¶rre", 
            "Stort str√∏mudfald i bydel", "Kommunal traktor punkteret", "Voldsom g√¶st ved indgang", "Udsmidning n√∏dvendig", 
            "Vold mod d√∏rmand", "Trussel mod personale", "G√¶st med v√•ben", "Beruset g√¶st", "Slagsm√•l i k√∏en", 
            "U√∏nsket g√¶st fors√∏ger adgang", "Mistanke om falsk ID", "G√¶st med stoffer", "N√¶gtelse af at forlade stedet", 
            "Trussel mod andre g√¶ster", "Gruppe optr√¶der truende", "Tyveri i garderobe/bar/kasse", "Uro i VIP-omr√•de", 
            "Seksuel chikane", "Overfald udenfor klub", "Ambulance tilkaldt til g√¶st", "Mistanke om tricktyveri", 
            "Overtr√¶delse af p√•bud", "Uro mellem g√¶ster og personale", "Mistanke om menneskehandel", "Mistanke om menneskehandel", 
            "N√∏dsituation ved n√∏dudgang", "Klager over diskrimination", "Klager over sikkerhed", "Vagtalarmer generelt", 
            "Indbrudsalarm", "Panikalarm", "Overfaldsalarm", "Udl√∏st brandalarm", "Mist√¶nkelig person observeret", 
            "D√∏r/port st√•r √•ben", "Glasbrudsalarm", "Fejl p√• alarmsystem", "Skalsikring brudt", "Tyveri fra butik", 
            "Person tilbageholdes", "Mist√¶nkelig bil p√• parkeringsplads", "Kamera offline", "Vagtrundering forsinket", 
            "Vagt har brug for backup", "Alarm for pengeskab", "Overfald p√• ansat", "H√¶rv√¶rk p√• toilet", "Str√∏msvigt i overv√•gning"
        ];

        let missionLog = [];
        let alarmLyd = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
        let alarmTimer = null;

        // --- Nye konstanter for hastighedskontrol --- 
        const OPFRISKNINGS_INTERVAL_MS = 300; 
        const STANDARD_REJSETID_SEKUNDER = 1700; 

        function opdaterAlarmInterval() {
            const ms = parseInt(document.getElementById("intervalV√¶lger").value);
            if (alarmTimer) clearInterval(alarmTimer);
            alarmTimer = setInterval(opretAlarm, ms);
        }

        let stationerSynlige = true;
        function toggleStationer() {
            stationerSynlige = !stationerSynlige;
            stationer.forEach(st => {
                if (stationerSynlige) map.addLayer(st.marker);
                else map.removeLayer(st.marker);
            });
        }

        function toggleTema() {
            document.body.classList.toggle("dark");
            localStorage.setItem("tema", document.body.classList.contains("dark") ? "dark" : "light");
        }

        window.onload = function() {
            if (localStorage.getItem("tema") === "dark") {
                document.body.classList.add("dark");
            }
            opdaterAlarmInterval();
        };

        function aktiverStationsTilstand() {
            stationsTilstand = true;
            alert("Klik p√• kortet for at placere en station.");
        }

        function distanceKm(lat1, lon1, lat2, lon2) {
            const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        map.on('click', e => {
            if (!stationsTilstand) return;
            const navn = prompt("Navn p√• station:");
            if (!navn) return;
            const marker = L.marker(e.latlng, {
                icon: L.divIcon({
                    html: `<div class='station-ikon'>üè¢ ${navn}</div>`,
                    className: ''
                })
            }).addTo(map);
            const station = { navn, position: e.latlng, marker, k√∏ret√∏jer: [] };
            station.marker.on('click', () => {
                const kNavn = prompt("Navn p√• k√∏ret√∏j:");
                const type = prompt("Type: brand, ambulance, politi");
                const k = { navn: kNavn, type, status: 'standby', station };
                const m = L.marker(e.latlng, { icon: lavIkon(k.status, k.navn) }).addTo(map);
                k.marker = m;
                station.k√∏ret√∏jer.push(k);
            });
            stationer.push(station);
            stationsTilstand = false;
        });

        function lavIkon(status, navn) {
            let farve = 'lightgreen';
            if (status === 'undervejs') farve = 'rgb(93, 226, 231)';
            else if (status === 'ved alarm') farve = 'red';
            else if (status === 'p√• vej hjem') farve = 'yellow';
            return L.divIcon({ html: `
                <div style='text-align:center;'>
                    <div style='width:12px;height:12px;background:${farve};border:2px solid #444;margin:auto;border-radius:4px;'></div>
                    <div style='font-size:10px;background:white;color:black;padding:2px 6px;border-radius:4px;margin-top:2px;width:60px;'>${navn}</div>
                </div>` });
        }

        function visK√∏ret√∏jsPanel() {
            const panel = document.getElementById("k√∏ret√∏jsPanel");
            if (panel.style.display === 'block') { panel.style.display = 'none'; return; }
            panel.innerHTML = "<b>V√¶lg k√∏ret√∏jer:</b><br>";
            panel.style.display = 'block';
            valgteK√∏ret√∏jer = [];
            stationer.forEach((st, sidx) => {
                panel.innerHTML += `<hr><b>${st.navn}</b><br>`;
                st.k√∏ret√∏jer.forEach((k, kidx) => {
                    panel.innerHTML += `<label><input type='checkbox' onchange='toggleK√∏ret√∏j(${sidx},${kidx})'> ${k.navn} (${k.type})</label><br>`;
                });
            });
            panel.innerHTML += `<br><button onclick='v√¶lgAlarmOgAfsend()'>Afsend valgte</button>`;
        }

        function toggleK√∏ret√∏j(s, k) {
            const k√∏ret√∏j = stationer[s].k√∏ret√∏jer[k];
            const index = valgteK√∏ret√∏jer.indexOf(k√∏ret√∏j);
            if (index > -1) valgteK√∏ret√∏jer.splice(index, 1);
            else valgteK√∏ret√∏jer.push(k√∏ret√∏j);
        }

        function v√¶lgAlarmOgAfsend() {
            const panel = document.getElementById("k√∏ret√∏jsPanel");
            panel.innerHTML = "<b>V√¶lg alarm til at sende k√∏ret√∏jerne til:</b><br>";
            if (alarmer.length === 0) {
                panel.innerHTML += "Ingen aktive alarmer.";
                return;
            }
            alarmer.forEach((alarm, idx) => {
                panel.innerHTML += `<button onclick='sendK√∏ret√∏jerTilAlarm(${idx})'>#${alarm.id} - ${alarm.type}</button><br>`;
            });
        }

        function visStatusPanel() {
            const panel = document.getElementById("statusPanel");
            if (panel.style.display === 'block') { panel.style.display = 'none'; return; }
            panel.innerHTML = '<b>Status for alle k√∏ret√∏jer:</b><br>';
            panel.style.display = 'block';
            stationer.forEach(st => {
                st.k√∏ret√∏jer.forEach(k => {
                    panel.innerHTML += `${k.navn} (${k.type}) - ${k.status}<br>`;
                });
            });
        }

        function opdaterK√∏ret√∏jsIkon(k) {
            if (k.marker) {
                k.marker.setIcon(lavIkon(k.status, k.navn));
            }
        }

        function sendK√∏ret√∏jerTilAlarm(alarmIndex) {
            const alarm = alarmer[alarmIndex];
            const startTid = Date.now();
            alarm.aktiveK√∏ret√∏jer = valgteK√∏ret√∏jer.length;

            valgteK√∏ret√∏jer.forEach(k => {
                if (!k.marker) return;
                k.status = "undervejs";
                opdaterK√∏ret√∏jsIkon(k);

                const routeControl = L.Routing.control({
                    waypoints: [k.marker.getLatLng(), L.latLng(alarm.position.lat, alarm.position.lng)],
                    routeWhileDragging: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    createMarker: () => null
                });

                routeControl.on('routesfound', function (e) {
                    const coords = e.routes[0].coordinates;
                    const antalOpdateringer = (STANDARD_REJSETID_SEKUNDER * 1000) / OPFRISKNINGS_INTERVAL_MS;
                    const stepSize = Math.max(1, Math.floor(coords.length / antalOpdateringer));
                    let i = 0;

                    const interval = setInterval(() => {
                        if (i >= coords.length) {
                            clearInterval(interval);
                            k.status = "ved alarm";
                            opdaterK√∏ret√∏jsIkon(k);

                            setTimeout(() => { 
                                k.status = "p√• vej hjem";  // K√∏ret√∏jet √¶ndrer status til "gul"
                                opdaterK√∏ret√∏jsIkon(k);

                                // N√•r k√∏ret√∏jet er p√• vej hjem, fjern alarmen
                                afslutAlarm(alarm, [k], startTid);  // Fjern alarmen med det samme

                                const hjemControl = L.Routing.control({
                                    waypoints: [alarm.position, k.station.position],
                                    routeWhileDragging: false,
                                    addWaypoints: false,
                                    draggableWaypoints: false,
                                    createMarker: () => null
                                });

                                hjemControl.on('routesfound', function (e2) {
                                    const hjemCoords = e2.routes[0].coordinates;
                                    const hjemAntalOpdateringer = (STANDARD_REJSETID_SEKUNDER * 1000) / OPFRISKNINGS_INTERVAL_MS;
                                    const hjemStep = Math.max(1, Math.floor(hjemCoords.length / hjemAntalOpdateringer));
                                    let j = 0;
                                    const hjemInterval = setInterval(() => {
                                        if (j >= hjemCoords.length) {
                                            clearInterval(hjemInterval);
                                            k.status = "standby";  // K√∏ret√∏jet er tilbage ved stationen
                                            opdaterK√∏ret√∏jsIkon(k);
                                            return;
                                        }
                                        k.marker.setLatLng(hjemCoords[j]);
                                        j += hjemStep;
                                    }, OPFRISKNINGS_INTERVAL_MS); 
                                });

                                hjemControl.route();
                            }, Math.floor(Math.random() * (300000 - 5000 + 1)) + 5000);  // Tid mellem 5 sekunder og 5 minutter
                            return;
                        }
                        k.marker.setLatLng(coords[i]);
                        i += stepSize;
                    }, OPFRISKNINGS_INTERVAL_MS); 
                });

                routeControl.route();
            });

            valgteK√∏ret√∏jer = [];
            document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
        }

        function opretAlarm() {
            if (stationer.length === 0) return;

            // V√¶lg en tilf√¶ldig station
            const tilf√¶ldigStationIndex = Math.floor(Math.random() * stationer.length);
            const station = stationer[tilf√¶ldigStationIndex];

            // Generer en alarm i n√¶rheden af stationen
            let lat, lng, dist;
            do {
                // Generer en tilf√¶ldig position indenfor 10 km fra stationen
                lat = station.position.lat + (Math.random() - 0.5) * 0.2;
                lng = station.position.lng + (Math.random() - 0.5) * 0.2;
                dist = distanceKm(station.position.lat, station.position.lng, lat, lng);
            } while (dist > 10);  // Kontrollerer, at alarmen ikke er l√¶ngere end 10 km v√¶k

            const type = alarmTyper[Math.floor(Math.random() * alarmTyper.length)];  // V√¶lg en tilf√¶ldig alarmtype
            const id = alarmer.length + 1;  // Giver alarmen et unikt id
            const ikonHtml = `<div class="blink-lampe"></div><div style='font-size:10px;text-align:center;margin-top:2px;'>${type}</div>`; 
            
            // Opret marker for alarmen
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({ html: ikonHtml })
            }).addTo(map).on('click', () => {
                // Hvis man klikker p√• alarmen, kan man fjerne den manuelt
                if (confirm("Fjern alarm manuelt?")) {
                    map.removeLayer(marker);
                    alarmer = alarmer.filter(a => a.id !== id);
                }
            });

            alarmer.push({ id, type, position: { lat, lng }, marker });  // Tilf√∏j alarmen til listen

            // Afspil alarmlyd
            alarmLyd.play().catch(() => {});
        }

        function afslutAlarm(alarm, k√∏ret√∏jer, startTid) {
            map.removeLayer(alarm.marker);
            alarmer = alarmer.filter(a => a.id !== alarm.id);
            const slutTid = Date.now();
            missionLog.push({
                alarmId: alarm.id,
                type: alarm.type,
                tid: new Date().toLocaleTimeString(),
                k√∏ret√∏jer: k√∏ret√∏jer.map(k => k.navn),
                responstid: ((slutTid - startTid) / 1000).toFixed(1) + ' sek'
            });
        }
    </script>
</body>
</html>
