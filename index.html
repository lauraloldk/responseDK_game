<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>ResponseDK</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        :root {
            --bg: #f5f5f5;
            --panel: #ffffff;
            --border: #ccc;
            --text: #222;
            --button-bg: #ffffff;
            --button-hover: #f0f0f0;
            --button-border: #ccc;
            --danger-button-bg: #f44336;
            --danger-button-hover: #d32f2f;
            --danger-button-text: white;
            --link-color: #007bff; /* Added for clickable links */
            --link-hover-color: #0056b3; /* Added for clickable links */
        }
        body.dark {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #444;
            --text: #f0f0f0;
            --button-bg: #2a2a2a;
            --button-hover: #333;
            --button-border: #555;
            --danger-button-bg: #cc2f2f;
            --danger-button-hover: #a02525;
            --danger-button-text: #f0f0f0;
            --link-color: #61dafb; /* Dark theme link color */
            --link-hover-color: #21a1f1; /* Dark theme link hover color */
        }
        #map {
            height: 90vh;
            width: 100%;
        }
        #controls {
            padding: 12px;
            background: var(--panel);
            color: var(--text);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            position: relative;
        }
        button, select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover, select:hover {
            background: var(--button-hover);
        }
        .danger-button {
            background-color: var(--danger-button-bg);
            color: var(--danger-button-text);
            border-color: var(--danger-button-bg);
        }
        .danger-button:hover {
            background-color: var(--danger-button-hover);
        }

        /* Paneler generelt */
        #k√∏ret√∏jsPanel, #statusPanel, #logPanel, #stationPanel, #testPanel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: var(--panel);
            padding: 14px;
            border-radius: 10px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: none;
            z-index: 1002;
            border: 1px solid var(--border);
            color: var(--text);
            min-width: 250px;
        }
        /* Specifik styling for stationPanel */
        #stationPanel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text);
        }
        #stationPanel .station-actions button {
            margin-bottom: 10px;
            width: 100%;
        }
        #stationPanel .vehicle-list div {
            padding: 5px 0;
            border-bottom: 1px dashed var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #stationPanel .vehicle-list div:last-child {
            border-bottom: none;
        }
        #stationPanel .vehicle-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }
        .close-btn { /* Style for the close button in panels */
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--text);
            padding: 0;
            margin: 0;
        }
        .close-btn:hover {
            color: #ff0000;
        }


        /* Mark√∏r-ikoner */
        .station-ikon {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            color: var(--text);
            display: inline-block;
            white-space: nowrap;
        }
        .blink-lampe {
            width: 14px;
            height: 14px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin: auto;
            box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
        }
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
            }
            50% {
                opacity: 0.2;
                box-shadow: 0 0 2px 1px rgba(255, 0, 0, 0.2);
            }
        }

        /* Styles for Save/Load Panel */
        #saveLoadPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            z-index: 2000; /* Higher z-index to be on top */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            color: var(--text);
            text-align: center;
        }
        #saveLoadPanel h2 {
            margin-top: 0;
            color: var(--text);
        }
        #saveLoadPanel textarea {
            width: calc(100% - 20px); /* Adjust width considering padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            resize: vertical; /* Allow vertical resizing */
        }
        #saveLoadPanel button {
            margin: 5px;
        }

        /* NEW: Styles for clickable station links in panels */
        .station-link {
            cursor: pointer;
            color: var(--link-color);
            text-decoration: underline;
            font-weight: bold; /* Make it stand out more */
        }
        .station-link:hover {
            color: var(--link-hover-color);
        }

        /* Ny style til timer visning */
        #gameTimeDisplay {
            margin-left: 20px; /* Juster afstand fra knapper */
            font-weight: bold;
            color: var(--text);
        }

        /* Styles for vehicle redirection */
        .vehicle-item-disabled {
            color: #888;
            font-style: italic;
            padding-left: 20px;
        }
        
        .vehicle-redirectable {
            background-color: rgba(248, 255, 0, 0.1);
            border-left: 3px solid rgb(248, 255, 0);
            padding-left: 5px;
            margin: 2px 0;
        }

        /* Styling for k√∏ret√∏jsikoner */
        .vehicle-ikon {
            pointer-events: auto;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .vehicle-ikon:hover {
            transform: scale(1.1);
        }
        
        /* Forbedret styling for bev√¶gende k√∏ret√∏jer */
        .moving-vehicle {
            pointer-events: auto;
            cursor: pointer;
            animation: pulseVehicle 2s infinite;
            transition: transform 0.2s ease;
        }
        
        .moving-vehicle:hover {
            transform: scale(1.2);
            animation-play-state: paused;
        }
        
        @keyframes pulseVehicle {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

    </style>
</head>
<body>
    <div id="controls">
        <button onclick="Game.activateStationMode()">‚ûï Tilf√∏j Station</button>
        <button onclick="Game.showVehicleSelectionPanel()">üö® Alarmer k√∏ret√∏j</button>
        <button onclick="Game.showTestPanel()" title="√Öbn test-v√¶rkt√∏jer">üîß Test-v√¶rkt√∏jer</button>
        <button onclick="Game.showStatusPanel()">üìã Status</button>
        <button onclick="Game.toggleStationsVisibility()">üè¢ Vis/Skjul stationer</button>
        <button onclick="Game.toggleTheme()">üåì Skift tema</button>
        <button onclick="showSaveLoadPanel('save')">üíæ Gem spil</button>
        <button onclick="showSaveLoadPanel('load')">üìÇ Indl√¶s spil</button>
        <button onclick="loadCustomROM()" title="Indl√¶s foruddefineret spil">üéÆ Load ROM</button>
        <label for="intervalV√¶lger">‚è±Ô∏è Alarm-interval:</label>
        <select id="intervalV√¶lger" onchange="Game.updateAlarmInterval()">
            <option value="60000">1 minut</option>
            <option value="120000" selected>2 minutter</option>
            <option value="300000">5 minutter</option>
            <option value="600000">10 minutter</option>
            <option value="5000">5 sekunder</option>
            <option value="pause">‚è∏Ô∏è Pause (24 timer)</option>
            <option value="random">üé≤ Tilf√¶ldig Interval (10s-5min)</option>
        </select>
        <span id="gameTimeDisplay">Tid: 00:00</span><span id="realClockDisplay" style="margin-left: 20px;">Klokken: --:--:--</span>
        <div style="margin-left: 20px; display: inline-flex; align-items: center; gap: 8px;">
            <label for="addressSearch">üîç Adresse:</label>
            <input type="text" id="addressSearch" placeholder="S√∏g efter adresse..." 
                   style="padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--button-bg); color: var(--text); width: 200px;"
                   onkeypress="handleAddressSearch(event)">
            <button onclick="searchAddress()" style="padding: 6px 10px;">S√∏g</button>
        </div>
    </div>
    <div id="map"></div>
    <div id="k√∏ret√∏jsPanel"></div>
    <div id="statusPanel">
        <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
        <h3>Spil Status</h3>
        
        <h4>Aktive Alarmer (<span id="activeAlarmsCount">0</span>)</h4>
        <ul id="alarmList">
            </ul>

        <h4>K√∏ret√∏jer i alt (<span id="totalVehiclesCount">0</span>)</h4>
        <ul id="vehicleList">
            </ul>

        <h4>Missions Log</h4>
        <ul id="missionLogList">
            </ul>
    </div>
    <div id="logPanel"></div>
    <div id="stationPanel"></div>
    <div id="testPanel">
        <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
        <h3>üîß Test-v√¶rkt√∏jer</h3>
        <p>V√¶rkt√∏jer til at teste alarm- og patrulje-funktionalitet:</p>
        
        <div style="margin: 10px 0;">
            <button onclick="testWaterAlarm()" title="Test vand-alarm funktionalitet" style="width: 100%; margin: 5px 0; padding: 10px;">
                üåä Test vand-alarm
            </button>
            <small style="color: var(--text); opacity: 0.7;">Fors√∏ger at spawne en alarm, der kun kan v√¶re p√• vand</small>
        </div>
        
        <div style="margin: 10px 0;">
            <button onclick="testLandAlarm()" title="Test land-alarm funktionalitet" style="width: 100%; margin: 5px 0; padding: 10px;">
                üèûÔ∏è Test land-alarm
            </button>
            <small style="color: var(--text); opacity: 0.7;">Spawner en standard alarm p√• land</small>
        </div>
        
        <div style="margin: 10px 0;">
            <button onclick="testPatrolWaterLogic()" title="Test patrulje vand/land logik" style="width: 100%; margin: 5px 0; padding: 10px;">
                üöÅ Test patrulje-logik
            </button>
            <small style="color: var(--text); opacity: 0.7;">Tester om k√∏ret√∏jer respekterer vand/land gr√¶nser</small>
        </div>
        
        <div style="margin: 10px 0;">
            <button onclick="testDanishWaterLocations()" title="Test danske vand-lokationer" style="width: 100%; margin: 5px 0; padding: 10px;">
                üó∫Ô∏è Test vand-detektering
            </button>
            <small style="color: var(--text); opacity: 0.7;">Tester detektering af danske vandomr√•der</small>
        </div>
    </div>

    <div id="saveLoadPanel">
        <h2 id="panelTitle"></h2>
        <div id="saveContent">
            <p>Kopier koden herunder for at gemme dit spil:</p>
            <textarea id="saveCodeOutput" rows="8"></textarea>
            <button onclick="copySaveCode()">Kopier kode</button>
        </div>
        <div id="loadContent" style="display: none;">
            <p>Inds√¶t din gemte kode her:</p>
            <textarea id="loadCodeInput" rows="8"></textarea>
            <button onclick="loadGameAction()">Indl√¶s spil</button>
        </div>
        <button onclick="hideSaveLoadPanel()">Luk</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <script src="map.js"></script>
    <script src="stationer.js"></script>
    <script src="alarmliste.js"></script>
    <script src="alarmer.js"></script>
    <script src="save.js"></script>
    <script src="load.js"></script>
    <script src="customROM.js"></script>

    <script>
        // Hoved Game objekt for at orkestrere de forskellige moduler
        const Game = {
            map: null,
            stations: [],
            alarms: [],
            selectedVehicles: [],
            stationModeActive: false,
            selectedStation: null,
            alarmSound: new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'),
            alarmTimer: null,
            missionLog: [],
            gameTime: 0, 
            randomAlarmMode: false, // New property for tracking random alarm mode 
            searchedLocation: null, // Store location from address search
            searchedAddress: null, // Store address name from search
            addressMarker: null, // Store reference to address marker 

            // Konstanter for animation
            REFRESH_INTERVAL_MS: 300,
            STANDARD_TRAVEL_TIME_SECONDS: 1700,
            
            // New setting for alarm spawn radius (in kilometers)
            ALARM_SPAWN_RADIUS_KM: 10, // Default to 10km for now

            init: function() {
                this.map = initMap(); 
                
                if (localStorage.getItem("tema") === "dark") {
                    document.body.classList.add("dark");
                }

                this.updateAlarmInterval();

                this.map.on('click', (e) => {
                    if (!this.stationModeActive) return;
                    addStationToMap(e.latlng); 
                    this.stationModeActive = false;
                });
                
                // Add an event listener for the 'beforeunload' event to prompt the user to save
                window.addEventListener('beforeunload', (event) => {
                    event.preventDefault(); 
                    event.returnValue = ''; 
                });

                // Initialiser/opdater statuspaneler med det samme
                this.updateStatusPanels(); 
                // Opdater spilletid hvert sekund
                // Rettet: Nu opdateres _kun_ spilletiden her, og Game.updateStatusPanels kaldes kun, n√•r UI kr√¶ver det.
                setInterval(() => {
                    this.gameTime++;
                    this.updateGameTimeDisplay(); // Ny funktion til kun at opdatere tiden
                }, 1000);
                
                // Load custom ROM if enabled (after a short delay to ensure everything is ready)
                setTimeout(() => {
                    loadCustomROMIfEnabled();
                    this.updateStatusPanels(); // Update UI after potential ROM load
                }, 100);
            },

            activateStationMode: function() {
                if (this.stationModeActive) { 
                    this.stationModeActive = false; 
                    alert("Tilf√∏j station annulleret."); 
                } else {
                    this.stationModeActive = true; 
                    this.hideAllPanels(); 
                    alert("Klik p√• kortet for at placere en station.");
                }
            },

            addStationAtSearchedLocation: function() {
                if (this.searchedLocation) {
                    // Remove the address marker if it exists
                    if (this.addressMarker) {
                        this.map.removeLayer(this.addressMarker);
                        this.addressMarker = null;
                    }
                    
                    // Directly prompt for station name and create station
                    const stationName = prompt("Indtast navn for den nye brandstation:");
                    if (!stationName) {
                        alert("Stationsnavnet m√• ikke v√¶re tomt.");
                        return;
                    }

                    const newStation = {
                        id: `station_${Date.now()}`,
                        navn: stationName,
                        position: this.searchedLocation,
                        k√∏ret√∏jer: [],
                        marker: null
                    };

                    // Create marker for the station
                    newStation.marker = createStationMarker(newStation.position, newStation.navn, newStation);
                    
                    this.stations.push(newStation);
                    this.updateStatusPanels();
                    alert(`${stationName} er blevet oprettet p√• ${this.searchedAddress}.`);
                    
                    // Reset button and clear stored location
                    this.resetAddStationButton();
                }
            },

            resetAddStationButton: function() {
                const addStationBtn = document.querySelector('button[onclick="Game.addStationAtSearchedLocation()"], button[onclick="Game.activateStationMode()"]');
                if (addStationBtn) {
                    addStationBtn.innerHTML = '‚ûï Tilf√∏j Station';
                    addStationBtn.onclick = () => Game.activateStationMode();
                }
                this.searchedLocation = null;
                this.searchedAddress = null;
                if (this.addressMarker) {
                    this.map.removeLayer(this.addressMarker);
                    this.addressMarker = null;
                }
            },

            showVehicleSelectionPanel: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    displayVehicleSelectionPanel(this.stations); 
                }
            },

            showStatusPanel: function() {
                const panel = document.getElementById("statusPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    // Opdater indholdet lige f√∏r visning for at sikre friske data
                    this.updateStatusPanels(); 
                    panel.style.display = 'block'; 
                }
            },

            showTestPanel: function() {
                const panel = document.getElementById("testPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    panel.style.display = 'block'; 
                }
            },

            toggleStationsVisibility: function() {
                toggleStationMarkers(this.stations); 
            },

            toggleTheme: function() {
                document.body.classList.toggle("dark");
                localStorage.setItem("tema", document.body.classList.contains("dark") ? "dark" : "light");
            },

            updateAlarmInterval: function() {
                const selectedValue = document.getElementById("intervalV√¶lger").value;
                if (this.alarmTimer) clearTimeout(this.alarmTimer);
                this.randomAlarmMode = false; // Reset random mode by default
                
                if (selectedValue === "pause") {
                    // Set interval to 24 hours (24 * 60 * 60 * 1000 = 86400000 ms)
                    this.scheduleNextAlarm(86400000);
                } else if (selectedValue === "random") {
                    this.randomAlarmMode = true;
                    this.scheduleRandomAlarm();
                } else {
                    // Normal interval
                    const ms = parseInt(selectedValue);
                    this.currentAlarmInterval = ms; // Gem det nuv√¶rende interval
                    this.scheduleNextAlarm(ms);
                }
            },

            // Ny funktion til at schedule n√¶ste alarm kun efter succes
            scheduleNextAlarm: function(intervalMs) {
                this.alarmTimer = setTimeout(async () => {
                    const success = await createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM);
                    if (success) {
                        // Kun schedule n√¶ste alarm hvis denne lykkedes
                        if (!this.randomAlarmMode) {
                            this.scheduleNextAlarm(intervalMs);
                        }
                    } else {
                        // Pr√∏v igen efter 10 sekunder hvis alarmen fejlede
                        console.log('Alarm oprettelse fejlede, pr√∏ver igen om 10 sekunder...');
                        this.scheduleNextAlarm(10000);
                    }
                }, intervalMs);
            },

            pauseAlarms: function() {
                if (this.alarmTimer) clearTimeout(this.alarmTimer);
                this.randomAlarmMode = false;
                // Set interval to 24 hours (24 * 60 * 60 * 1000 = 86400000 ms)
                this.scheduleNextAlarm(86400000);
                alert("Alarmer sat p√• pause - n√¶ste alarm om 24 timer");
            },

            randomAlarmInterval: function() {
                if (this.alarmTimer) clearTimeout(this.alarmTimer);
                this.randomAlarmMode = true;
                this.scheduleRandomAlarm();
                alert("Tilf√¶ldig alarm-interval aktiveret (10 sekunder - 5 minutter)");
            },

            scheduleRandomAlarm: function() {
                if (!this.randomAlarmMode) return;
                
                // Random interval between 10 seconds (10000ms) and 5 minutes (300000ms)
                const minInterval = 10000;  // 10 seconds
                const maxInterval = 300000; // 5 minutes
                const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
                
                this.alarmTimer = setTimeout(async () => {
                    const success = await createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM);
                    if (success) {
                        // Kun schedule n√¶ste tilf√¶ldige alarm hvis denne lykkedes
                        this.scheduleRandomAlarm();
                    } else {
                        // Pr√∏v igen med et kortere interval hvis alarmen fejlede
                        console.log('Random alarm oprettelse fejlede, pr√∏ver igen om 10 sekunder...');
                        this.alarmTimer = setTimeout(() => this.scheduleRandomAlarm(), 10000);
                    }
                }, randomInterval);
            },
            
            sendSelectedVehiclesToAlarm: function(alarmIndex) {
                const alarm = this.alarms[alarmIndex];
                if (!alarm) return;
                
                sendVehiclesToAlarm(
                    alarm, 
                    this.selectedVehicles, 
                    this.map, 
                    this.REFRESH_INTERVAL_MS, 
                    this.STANDARD_TRAVEL_TIME_SECONDS, 
                    this.stations, 
                    this.alarms, 
                    this.missionLog
                );
                this.selectedVehicles = []; 
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
                this.updateStatusPanels(); // Update status after dispatch
            },

            chooseAlarmAndDispatch: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                panel.innerHTML = `
                    <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
                    <b>V√¶lg alarm til at sende k√∏ret√∏jerne til:</b><br>
                `;
                if (this.alarms.length === 0) { 
                    panel.innerHTML += "Ingen aktive alarmer.";
                    return;
                }
                this.alarms.forEach((alarm, idx) => { 
                    panel.innerHTML += `<button onclick='sendK√∏ret√∏jerTilAlarm(${idx})'>#${alarm.id} - ${alarm.type}</button><br>`;
                });
            },
            
            hideAllPanels: function() {
                document.getElementById("stationPanel").style.display = 'none';
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
                document.getElementById("statusPanel").style.display = 'none';
                document.getElementById("logPanel").style.display = 'none'; 
                document.getElementById("testPanel").style.display = 'none'; 
                document.getElementById("saveLoadPanel").style.display = 'none'; 
            },

            // --- NY FUNKTION: Opdaterer alle statuspaneler ---
            updateStatusPanels: function() {
                // Opdater alarm liste
                const alarmList = document.getElementById('alarmList');
                alarmList.innerHTML = '';
                this.alarms.forEach(alarm => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `Alarm #${alarm.id}: ${alarm.type}`;
                    alarmList.appendChild(listItem);
                });
                document.getElementById('activeAlarmsCount').textContent = this.alarms.length;

                // Opdater k√∏ret√∏jsliste MED KLIKBART STATIONSNAVN
                const vehicleList = document.getElementById('vehicleList');
                vehicleList.innerHTML = '';
                let totalVehicles = 0;
                this.stations.forEach(station => {
                    station.k√∏ret√∏jer.forEach(vehicle => {
                        totalVehicles++;
                        const listItem = document.createElement('li');
                        // G√∏r stationens navn klikbart
                        const stationLink = `<span class="station-link" onclick="showStationDetails(Game.stations.find(s => s.id === '${station.id}'))">${station.navn}</span>`;

                        listItem.innerHTML = `
                            ${vehicle.navn} (${vehicle.type}) - Status: ${vehicle.status} - Station: ${stationLink}
                        `;
                        vehicleList.appendChild(listItem);
                    });
                });
                document.getElementById('totalVehiclesCount').textContent = totalVehicles;

                // Opdater missionslog
                const missionLogList = document.getElementById('missionLogList');
                missionLogList.innerHTML = '';
                this.missionLog.forEach(log => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Alarm ${log.alarmId} (${log.type}) l√∏st af ${log.vehicles.join(', ')} p√• ${log.responseTime} (${log.time})`;
                    missionLogList.appendChild(listItem);
                });

                // Opdater spilletid (flyttet til separat funktion for at undg√• fejl)
                this.updateGameTimeDisplay();
            },

            // Ny funktion til kun at opdatere spilletiden
            updateGameTimeDisplay: function() {
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = this.gameTime % 60;
                const gameTimeElement = document.getElementById('gameTimeDisplay');
                if (gameTimeElement) { // Tjek om elementet eksisterer, f√∏r du opdaterer
                    gameTimeElement.textContent = `Tid: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        };

        // K√∏r initialiseringsfunktionen n√•r DOM er indl√¶st
        document.addEventListener('DOMContentLoaded', () => {
            Game.init();
        });

        // Vis aktuelt klokkesl√¶t (realtid)
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('da-DK'); // Format: HH:MM:SS
            const clockDisplay = document.getElementById('realClockDisplay');
            if (clockDisplay) clockDisplay.textContent = `Klokken: ${timeString}`;
        }, 1000);


        // Lav nogle globale funktioner, som HTML kan kalde direkte
        function sendK√∏ret√∏jerTilAlarm(alarmIndex) {
            Game.sendSelectedVehiclesToAlarm(alarmIndex);
        }

        function selectVehicleForDispatch(stationIdx, vehicleIdx) {
            const vehicle = Game.stations[stationIdx].k√∏ret√∏jer[vehicleIdx];
            const index = Game.selectedVehicles.indexOf(vehicle);
            if (index > -1) Game.selectedVehicles.splice(index, 1);
            else Game.selectedVehicles.push(vehicle);
        }

        // --- STATIONS FUNKTIONER ER FLYTTET TIL STATIONER.JS ---
        // F√∏lgende funktioner er nu i stationer.js:
        // - showStationDetails()
        // - addVehicleToSelectedStation()
        // - deleteVehicleFromStation()
        // - editVehicleInStation() 
        // - deleteSelectedStation()
        // - renameSelectedStation()
        // --- END STATIONS FUNKTIONER ---

        // --- GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---
        function showSaveLoadPanel(mode) {
            Game.hideAllPanels(); // Hide other panels first
            const panel = document.getElementById('saveLoadPanel');
            const panelTitle = document.getElementById('panelTitle');
            const saveContent = document.getElementById('saveContent');
            const loadContent = document.getElementById('loadContent');
            
            panel.style.display = 'block';

            if (mode === 'save') {
                panelTitle.textContent = "Gem spil";
                saveContent.style.display = 'block';
                loadContent.style.display = 'none';
                document.getElementById('saveCodeOutput').value = generateSaveCode(Game); // Call save function
                document.getElementById('saveCodeOutput').select(); // Select text for easy copying
            } else if (mode === 'load') {
                panelTitle.textContent = "Indl√¶s spil";
                saveContent.style.display = 'none';
                loadContent.style.display = 'block';
                document.getElementById('loadCodeInput').value = ''; // Clear previous input
            }
        }

        function hideSaveLoadPanel() {
            document.getElementById('saveLoadPanel').style.display = 'none';
        }

        function copySaveCode() {
            const saveCodeOutput = document.getElementById('saveCodeOutput');
            saveCodeOutput.select();
            document.execCommand('copy');
            alert("Kode kopieret til udklipsholder!");
        }
        // loadGameAction is now defined in load.js
        // --- END GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---

        // --- ADDRESS SEARCH FUNCTIONS ---
        function handleAddressSearch(event) {
            if (event.key === 'Enter') {
                searchAddress();
            }
        }

        function searchAddress() {
            const query = document.getElementById('addressSearch').value.trim();
            if (!query) {
                alert('Indtast venligst en adresse at s√∏ge efter.');
                return;
            }

            // Use Nominatim (OpenStreetMap) geocoding service
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=dk&limit=5`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        showAddressResults(data, query);
                    } else {
                        alert('Ingen resultater fundet for den angivne adresse.');
                    }
                })
                .catch(error => {
                    console.error('Fejl ved s√∏gning:', error);
                    alert('Der opstod en fejl under s√∏gningen. Pr√∏v venligst igen.');
                });
        }

        function showAddressResults(results, originalQuery) {
            Game.hideAllPanels(); // Hide other panels first
            const panel = document.getElementById('k√∏ret√∏jsPanel');
            
            let resultsHTML = `
                <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
                <h3>Adresse s√∏geresultater</h3>
                <p>S√∏gte efter: <strong>${originalQuery}</strong></p>
                <p>Klik p√• en adresse for at g√• til den p√• kortet:</p>
            `;
            
            results.forEach((result, index) => {
                resultsHTML += `
                    <div style="margin-bottom: 10px; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--button-bg);">
                        <strong>${result.display_name}</strong><br>
                        <button onclick="goToAddress({lat: ${result.lat}, lng: ${result.lon}, name: '${result.display_name.replace(/'/g, "&apos;")}'})">G√• til adresse</button>
                        <button onclick="Game.addStationAtAddress({lat: ${result.lat}, lng: ${result.lon}})">Tilf√∏j Station</button>
                    </div>
                `;
            });
            
            panel.innerHTML = resultsHTML;
            panel.style.display = 'block';
        }

        function goToAddress(addressData) {
            Game.hideAllPanels();
            Game.map.setView([addressData.lat, addressData.lng], 15); // Zoom to the address
            
            // Optional: Add a temporary marker to show the searched location
            const tempMarker = L.marker([addressData.lat, addressData.lng])
                .addTo(Game.map)
                .bindPopup(`<strong>S√∏gt adresse:</strong><br>${addressData.name}`)
                .openPopup();
            
            // Remove the temporary marker after 10 seconds
            setTimeout(() => {
                Game.map.removeLayer(tempMarker);
            }, 10000);
        }
        // --- END ADDRESS SEARCH FUNCTIONS ---

        // --- PATROL FUNCTIONS ---
        function findVehicleById(vehicleId) {
            for (const station of Game.stations) {
                for (const vehicle of station.k√∏ret√∏jer) {
                    if (vehicle.id === vehicleId) {
                        return vehicle;
                    }
                }
            }
            return null;
        }

        function startVehiclePatrolling(vehicleId) {
            startPatrolling(vehicleId);
        }

        function stopVehiclePatrolling(vehicleId) {
            stopPatrolling(vehicleId);
        }

        function sendVehicleToHome(vehicleId) {
            sendVehicleHome(vehicleId);
        }
        // --- END PATROL FUNCTIONS ---
        
        // --- TEST FUNCTIONS ---
        async function testWaterAlarm() {
            if (Game.stations.length === 0) {
                alert('Tilf√∏j venligst mindst √©n station f√∏rst.');
                return;
            }
            
            console.log('Tester vand-alarm funktionalitet...');
            
            // Gennemtving en vand-alarm til test
            const waterAlarms = alarmTypes.filter(alarm => alarm.includes('#only-on-water#'));
            if (waterAlarms.length === 0) {
                alert('Ingen vand-alarmer fundet i alarmlisten!');
                return;
            }
            
            const selectedWaterAlarm = waterAlarms[Math.floor(Math.random() * waterAlarms.length)];
            console.log(`Fors√∏ger at spawne vand-alarm: "${selectedWaterAlarm}"`);
            
            // Brug createAlarm funktionalitet men med en specifik alarm-type
            await createTestWaterAlarm(Game.stations, Game.alarms, Game.alarmSound, Game.ALARM_SPAWN_RADIUS_KM, selectedWaterAlarm);
        }
        
        // Specialiseret funktion til at teste vand-alarmer
        async function createTestWaterAlarm(stations, alarmsArray, alarmSound, spawnRadiusKm, forcedAlarmType) {
            if (stations.length === 0) return;

            const randomStationIndex = Math.floor(Math.random() * stations.length);
            const station = stations[randomStationIndex];
            
            let lat, lng, dist;
            let validLocation = false;
            let attempts = 0;
            const maxAttempts = 30; // Flere fors√∏g for test
            
            console.log(`S√∏ger efter vand-lokation for "${forcedAlarmType}"...`);
            
            while (!validLocation && attempts < maxAttempts) {
                // Generer tilf√¶ldig lokation inden for radius
                lat = station.position.lat + (Math.random() - 0.5) * (spawnRadiusKm / 111.32);
                lng = station.position.lng + (Math.random() - 0.5) * (spawnRadiusKm / (111.32 * Math.cos(station.position.lat * Math.PI / 180)));
                dist = distanceKm(station.position.lat, station.position.lng, lat, lng);
                
                if (dist <= spawnRadiusKm) {
                    const isOnWater = await isLocationOnWater(lat, lng);
                    console.log(`Test lokation ${lat.toFixed(4)}, ${lng.toFixed(4)} - p√• vand: ${isOnWater}`);
                    
                    if (isOnWater) {
                        validLocation = true;
                        console.log('‚úì Vand-lokation fundet for test!');
                    }
                }
                
                attempts++;
            }
            
            if (!validLocation) {
                alert(`Kunne ikke finde en vand-lokation efter ${maxAttempts} fors√∏g. Pr√∏v med en st√∏rre radius eller en anden station.`);
                return;
            }
            
            // Rens alarm-teksten for tags
            const cleanedAlarmType = cleanAlarmText(forcedAlarmType);
            
            const id = nextAlarmId++;
            const alarm = { 
                id, 
                type: cleanedAlarmType, 
                position: { lat, lng }, 
                marker: null, 
                dispatchedVehiclesCount: 0,
                resolvedVehiclesCount: 0,
                creationTime: Game.gameTime
            };
            
            alarm.marker = createAlarmMarker({ lat, lng }, id, cleanedAlarmType, alarm); 
            alarmsArray.push(alarm);
            alarmSound.play().catch(() => {});
            Game.updateStatusPanels();
            
            console.log(`üåä Test vand-alarm spawnet: "${cleanedAlarmType}" p√• ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
        }
        
        // Test specifikke danske vand-lokationer
        async function testDanishWaterLocations() {
            const testLocations = [
                { lat: 55.2, lng: 12.2, name: "√òresund" },
                { lat: 57.7, lng: 10.6, name: "Skagerrak" },
                { lat: 56.0, lng: 9.9, name: "Limfjorden" },
                { lat: 55.4, lng: 11.1, name: "Store B√¶lt" },
                { lat: 54.9, lng: 11.9, name: "Lolland kyst" }
            ];
            
            console.log('Tester danske vand-lokationer:');
            for (const loc of testLocations) {
                const isWater = await isLocationOnWater(loc.lat, loc.lng);
                console.log(`${loc.name}: ${isWater ? 'üåä VAND' : 'üèûÔ∏è LAND'}`);
            }
        }
        
        // Test land-alarm funktionalitet
        async function testLandAlarm() {
            if (Game.stations.length === 0) {
                alert('Tilf√∏j venligst mindst √©n station f√∏rst.');
                return;
            }
            
            console.log('Tester land-alarm funktionalitet...');
            
            const landAlarms = alarmTypes.filter(alarm => 
                !alarm.includes('#only-on-water#') && !alarm.includes('#can-spawn-on-water#')
            );
            
            if (landAlarms.length === 0) {
                alert('Ingen land-alarmer fundet!');
                return;
            }
            
            const selectedLandAlarm = landAlarms[Math.floor(Math.random() * landAlarms.length)];
            console.log(`Fors√∏ger at spawne land-alarm: "${selectedLandAlarm}"`);
            
            // Brug standard createAlarm - den burde spawne p√• land
            await createAlarm(Game.stations, Game.alarms, Game.alarmSound, Game.ALARM_SPAWN_RADIUS_KM);
        }
        
        // Test patrulje vand/land logik
        async function testPatrolWaterLogic() {
            if (Game.stations.length === 0) {
                alert('Tilf√∏j venligst mindst √©n station f√∏rst.');
                return;
            }
            
            // Find det f√∏rste k√∏ret√∏j der patrouillerer
            let patrollingVehicle = null;
            for (const station of Game.stations) {
                for (const vehicle of station.k√∏ret√∏jer) {
                    if (vehicle.status === 'patrouillerer') {
                        patrollingVehicle = vehicle;
                        break;
                    }
                }
                if (patrollingVehicle) break;
            }
            
            if (!patrollingVehicle) {
                alert('Ingen k√∏ret√∏jer patrouillerer i √∏jeblikket. Start en patrulje f√∏rst.');
                return;
            }
            
            const isHeli = isHelicopter(patrollingVehicle);
            console.log(`üîç Testing patrulje-logik for ${patrollingVehicle.navn} (${isHeli ? 'Helikopter' : 'Landk√∏ret√∏j'})`);
            
            if (isHeli) {
                console.log('üöÅ Helikopter kan flyve over vand og land');
            } else {
                console.log('üöó Landk√∏ret√∏j skal holde sig p√• land');
            }
            
            // Gennemtving et nyt patrulje-punkt
            await moveToRandomPatrolPoint(patrollingVehicle);
        }
        // --- END TEST FUNCTIONS ---
    </script>
</body>
</html>