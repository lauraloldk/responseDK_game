<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>ResponseDK</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        :root {
            --bg: #f5f5f5;
            --panel: #ffffff;
            --border: #ccc;
            --text: #222;
            --button-bg: #ffffff;
            --button-hover: #f0f0f0;
            --button-border: #ccc;
            --danger-button-bg: #f44336;
            --danger-button-hover: #d32f2f;
            --danger-button-text: white;
            --link-color: #007bff; /* Added for clickable links */
            --link-hover-color: #0056b3; /* Added for clickable links */
        }
        body.dark {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #444;
            --text: #f0f0f0;
            --button-bg: #2a2a2a;
            --button-hover: #333;
            --button-border: #555;
            --danger-button-bg: #cc2f2f;
            --danger-button-hover: #a02525;
            --danger-button-text: #f0f0f0;
            --link-color: #61dafb; /* Dark theme link color */
            --link-hover-color: #21a1f1; /* Dark theme link hover color */
        }
        #map {
            height: 90vh;
            width: 100%;
        }
        #controls {
            padding: 12px;
            background: var(--panel);
            color: var(--text);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            position: relative;
        }
        button, select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover, select:hover {
            background: var(--button-hover);
        }
        .danger-button {
            background-color: var(--danger-button-bg);
            color: var(--danger-button-text);
            border-color: var(--danger-button-bg);
        }
        .danger-button:hover {
            background-color: var(--danger-button-hover);
        }

        /* Paneler generelt */
        #k√∏ret√∏jsPanel, #statusPanel, #logPanel, #stationPanel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: var(--panel);
            padding: 14px;
            border-radius: 10px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: none;
            z-index: 1002;
            border: 1px solid var(--border);
            color: var(--text);
            min-width: 250px;
        }
        /* Specifik styling for stationPanel */
        #stationPanel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text);
        }
        #stationPanel .station-actions button {
            margin-bottom: 10px;
            width: 100%;
        }
        #stationPanel .vehicle-list div {
            padding: 5px 0;
            border-bottom: 1px dashed var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #stationPanel .vehicle-list div:last-child {
            border-bottom: none;
        }
        #stationPanel .vehicle-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }
        .close-btn { /* Style for the close button in panels */
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--text);
            padding: 0;
            margin: 0;
        }
        .close-btn:hover {
            color: #ff0000;
        }


        /* Mark√∏r-ikoner */
        .station-ikon {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            color: var(--text);
            display: inline-block;
            white-space: nowrap;
        }
        .blink-lampe {
            width: 14px;
            height: 14px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin: auto;
            box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
        }
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
            }
            50% {
                opacity: 0.2;
                box-shadow: 0 0 2px 1px rgba(255, 0, 0, 0.2);
            }
        }

        /* Styles for Save/Load Panel */
        #saveLoadPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            z-index: 2000; /* Higher z-index to be on top */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            color: var(--text);
            text-align: center;
        }
        #saveLoadPanel h2 {
            margin-top: 0;
            color: var(--text);
        }
        #saveLoadPanel textarea {
            width: calc(100% - 20px); /* Adjust width considering padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            resize: vertical; /* Allow vertical resizing */
        }
        #saveLoadPanel button {
            margin: 5px;
        }

        /* NEW: Styles for clickable station links in panels */
        .station-link {
            cursor: pointer;
            color: var(--link-color);
            text-decoration: underline;
            font-weight: bold; /* Make it stand out more */
        }
        .station-link:hover {
            color: var(--link-hover-color);
        }

        /* Ny style til timer visning */
        #gameTimeDisplay {
            margin-left: 20px; /* Juster afstand fra knapper */
            font-weight: bold;
            color: var(--text);
        }

        /* Styles for vehicle redirection */
        .vehicle-item-disabled {
            color: #888;
            font-style: italic;
            padding-left: 20px;
        }
        
        .vehicle-redirectable {
            background-color: rgba(248, 255, 0, 0.1);
            border-left: 3px solid rgb(248, 255, 0);
            padding-left: 5px;
            margin: 2px 0;
        }

    </style>
</head>
<body>
    <div id="controls">
        <button onclick="Game.activateStationMode()">‚ûï Tilf√∏j Station</button>
        <button onclick="Game.showVehicleSelectionPanel()">üö® Alarmer k√∏ret√∏j</button>
        <button onclick="Game.showStatusPanel()">üìã Status</button>
        <button onclick="Game.toggleStationsVisibility()">üè¢ Vis/Skjul stationer</button>
        <button onclick="Game.toggleTheme()">üåì Skift tema</button>
        <button onclick="showSaveLoadPanel('save')">üíæ Gem spil</button>
        <button onclick="showSaveLoadPanel('load')">üìÇ Indl√¶s spil</button>
        <label for="intervalV√¶lger">‚è±Ô∏è Alarm-interval:</label>
        <select id="intervalV√¶lger" onchange="Game.updateAlarmInterval()">
            <option value="60000">1 minut</option>
            <option value="120000" selected>2 minutter</option>
            <option value="300000">5 minutter</option>
            <option value="600000">10 minutter</option>
            <option value="5000">5 sekunder</option>
            <option value="pause">‚è∏Ô∏è Pause (24 timer)</option>
            <option value="random">üé≤ Tilf√¶ldig Interval (10s-5min)</option>
        </select>
        <span id="gameTimeDisplay">Tid: 00:00</span><span id="realClockDisplay" style="margin-left: 20px;">Klokken: --:--:--</span>
        <div style="margin-left: 20px; display: inline-flex; align-items: center; gap: 8px;">
            <label for="addressSearch">üîç Adresse:</label>
            <input type="text" id="addressSearch" placeholder="S√∏g efter adresse..." 
                   style="padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--button-bg); color: var(--text); width: 200px;"
                   onkeypress="handleAddressSearch(event)">
            <button onclick="searchAddress()" style="padding: 6px 10px;">S√∏g</button>
        </div>
    </div>
    <div id="map"></div>
    <div id="k√∏ret√∏jsPanel"></div>
    <div id="statusPanel">
        <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
        <h3>Spil Status</h3>
        
        <h4>Aktive Alarmer (<span id="activeAlarmsCount">0</span>)</h4>
        <ul id="alarmList">
            </ul>

        <h4>K√∏ret√∏jer i alt (<span id="totalVehiclesCount">0</span>)</h4>
        <ul id="vehicleList">
            </ul>

        <h4>Missions Log</h4>
        <ul id="missionLogList">
            </ul>
    </div>
    <div id="logPanel"></div>
    <div id="stationPanel"></div>

    <div id="saveLoadPanel">
        <h2 id="panelTitle"></h2>
        <div id="saveContent">
            <p>Kopier koden herunder for at gemme dit spil:</p>
            <textarea id="saveCodeOutput" rows="8"></textarea>
            <button onclick="copySaveCode()">Kopier kode</button>
        </div>
        <div id="loadContent" style="display: none;">
            <p>Inds√¶t din gemte kode her:</p>
            <textarea id="loadCodeInput" rows="8"></textarea>
            <button onclick="loadGameAction()">Indl√¶s spil</button>
        </div>
        <button onclick="hideSaveLoadPanel()">Luk</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <script src="map.js"></script>
    <script src="stationer.js"></script>
    <script src="alarmliste.js"></script>
    <script src="alarmer.js"></script>
    <script src="save.js"></script>

    <script>
        // Hoved Game objekt for at orkestrere de forskellige moduler
        const Game = {
            map: null,
            stations: [],
            alarms: [],
            selectedVehicles: [],
            stationModeActive: false,
            selectedStation: null,
            alarmSound: new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'),
            alarmTimer: null,
            missionLog: [],
            gameTime: 0, 
            randomAlarmMode: false, // New property for tracking random alarm mode 

            // Konstanter for animation
            REFRESH_INTERVAL_MS: 300,
            STANDARD_TRAVEL_TIME_SECONDS: 1700,
            
            // New setting for alarm spawn radius (in kilometers)
            ALARM_SPAWN_RADIUS_KM: 10, // Default to 10km for now

            init: function() {
                this.map = initMap(); 
                
                if (localStorage.getItem("tema") === "dark") {
                    document.body.classList.add("dark");
                }

                this.updateAlarmInterval();

                this.map.on('click', (e) => {
                    if (!this.stationModeActive) return;
                    addStationToMap(e.latlng); 
                    this.stationModeActive = false;
                });
                
                // Add an event listener for the 'beforeunload' event to prompt the user to save
                window.addEventListener('beforeunload', (event) => {
                    event.preventDefault(); 
                    event.returnValue = ''; 
                });

                // Initialiser/opdater statuspaneler med det samme
                this.updateStatusPanels(); 
                // Opdater spilletid hvert sekund
                // Rettet: Nu opdateres _kun_ spilletiden her, og Game.updateStatusPanels kaldes kun, n√•r UI kr√¶ver det.
                setInterval(() => {
                    this.gameTime++;
                    this.updateGameTimeDisplay(); // Ny funktion til kun at opdatere tiden
                }, 1000);
            },

            activateStationMode: function() {
                if (this.stationModeActive) { 
                    this.stationModeActive = false; 
                    alert("Tilf√∏j station annulleret."); 
                } else {
                    this.stationModeActive = true; 
                    this.hideAllPanels(); 
                    alert("Klik p√• kortet for at placere en station.");
                }
            },

            showVehicleSelectionPanel: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    displayVehicleSelectionPanel(this.stations); 
                }
            },

            showStatusPanel: function() {
                const panel = document.getElementById("statusPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    // Opdater indholdet lige f√∏r visning for at sikre friske data
                    this.updateStatusPanels(); 
                    panel.style.display = 'block'; 
                }
            },

            toggleStationsVisibility: function() {
                toggleStationMarkers(this.stations); 
            },

            toggleTheme: function() {
                document.body.classList.toggle("dark");
                localStorage.setItem("tema", document.body.classList.contains("dark") ? "dark" : "light");
            },

            updateAlarmInterval: function() {
                const selectedValue = document.getElementById("intervalV√¶lger").value;
                if (this.alarmTimer) clearInterval(this.alarmTimer);
                this.randomAlarmMode = false; // Reset random mode by default
                
                if (selectedValue === "pause") {
                    // Set interval to 24 hours (24 * 60 * 60 * 1000 = 86400000 ms)
                    this.alarmTimer = setInterval(() => {
                        createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM); 
                    }, 86400000);
                } else if (selectedValue === "random") {
                    this.randomAlarmMode = true;
                    this.scheduleRandomAlarm();
                } else {
                    // Normal interval
                    const ms = parseInt(selectedValue);
                    this.alarmTimer = setInterval(() => {
                        createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM); 
                    }, ms);
                }
            },

            pauseAlarms: function() {
                if (this.alarmTimer) clearInterval(this.alarmTimer);
                this.randomAlarmMode = false;
                // Set interval to 24 hours (24 * 60 * 60 * 1000 = 86400000 ms)
                this.alarmTimer = setInterval(() => {
                    createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM); 
                }, 86400000);
                alert("Alarmer sat p√• pause - n√¶ste alarm om 24 timer");
            },

            randomAlarmInterval: function() {
                if (this.alarmTimer) clearInterval(this.alarmTimer);
                this.randomAlarmMode = true;
                this.scheduleRandomAlarm();
                alert("Tilf√¶ldig alarm-interval aktiveret (10 sekunder - 5 minutter)");
            },

            scheduleRandomAlarm: function() {
                if (!this.randomAlarmMode) return;
                
                // Random interval between 10 seconds (10000ms) and 5 minutes (300000ms)
                const minInterval = 10000;  // 10 seconds
                const maxInterval = 300000; // 5 minutes
                const randomInterval = Math.floor(Math.random() * (maxInterval - minInterval + 1)) + minInterval;
                
                this.alarmTimer = setTimeout(() => {
                    createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM);
                    this.scheduleRandomAlarm(); // Schedule next random alarm
                }, randomInterval);
            },
            
            sendSelectedVehiclesToAlarm: function(alarmIndex) {
                const alarm = this.alarms[alarmIndex];
                if (!alarm) return;
                
                sendVehiclesToAlarm(
                    alarm, 
                    this.selectedVehicles, 
                    this.map, 
                    this.REFRESH_INTERVAL_MS, 
                    this.STANDARD_TRAVEL_TIME_SECONDS, 
                    this.stations, 
                    this.alarms, 
                    this.missionLog
                );
                this.selectedVehicles = []; 
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
                this.updateStatusPanels(); // Update status after dispatch
            },

            chooseAlarmAndDispatch: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                panel.innerHTML = `
                    <button class="close-btn" onclick="Game.hideAllPanels()">X</button>
                    <b>V√¶lg alarm til at sende k√∏ret√∏jerne til:</b><br>
                `;
                if (this.alarms.length === 0) { 
                    panel.innerHTML += "Ingen aktive alarmer.";
                    return;
                }
                this.alarms.forEach((alarm, idx) => { 
                    panel.innerHTML += `<button onclick='sendK√∏ret√∏jerTilAlarm(${idx})'>#${alarm.id} - ${alarm.type}</button><br>`;
                });
            },
            
            hideAllPanels: function() {
                document.getElementById("stationPanel").style.display = 'none';
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
                document.getElementById("statusPanel").style.display = 'none';
                document.getElementById("logPanel").style.display = 'none'; 
                document.getElementById("saveLoadPanel").style.display = 'none'; 
            },

            // --- NY FUNKTION: Opdaterer alle statuspaneler ---
            updateStatusPanels: function() {
                // Opdater alarm liste
                const alarmList = document.getElementById('alarmList');
                alarmList.innerHTML = '';
                this.alarms.forEach(alarm => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `Alarm #${alarm.id}: ${alarm.type}`;
                    alarmList.appendChild(listItem);
                });
                document.getElementById('activeAlarmsCount').textContent = this.alarms.length;

                // Opdater k√∏ret√∏jsliste MED KLIKBART STATIONSNAVN
                const vehicleList = document.getElementById('vehicleList');
                vehicleList.innerHTML = '';
                let totalVehicles = 0;
                this.stations.forEach(station => {
                    station.k√∏ret√∏jer.forEach(vehicle => {
                        totalVehicles++;
                        const listItem = document.createElement('li');
                        // G√∏r stationens navn klikbart
                        const stationLink = `<span class="station-link" onclick="showStationDetails(Game.stations.find(s => s.id === '${station.id}'))">${station.navn}</span>`;

                        listItem.innerHTML = `
                            ${vehicle.navn} (${vehicle.type}) - Status: ${vehicle.status} - Station: ${stationLink}
                        `;
                        vehicleList.appendChild(listItem);
                    });
                });
                document.getElementById('totalVehiclesCount').textContent = totalVehicles;

                // Opdater missionslog
                const missionLogList = document.getElementById('missionLogList');
                missionLogList.innerHTML = '';
                this.missionLog.forEach(log => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `Alarm ${log.alarmId} (${log.type}) l√∏st af ${log.vehicles.join(', ')} p√• ${log.responseTime} (${log.time})`;
                    missionLogList.appendChild(listItem);
                });

                // Opdater spilletid (flyttet til separat funktion for at undg√• fejl)
                this.updateGameTimeDisplay();
            },

            // Ny funktion til kun at opdatere spilletiden
            updateGameTimeDisplay: function() {
                const minutes = Math.floor(this.gameTime / 60);
                const seconds = this.gameTime % 60;
                const gameTimeElement = document.getElementById('gameTimeDisplay');
                if (gameTimeElement) { // Tjek om elementet eksisterer, f√∏r du opdaterer
                    gameTimeElement.textContent = `Tid: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
        };

        // K√∏r initialiseringsfunktionen n√•r DOM er indl√¶st
        document.addEventListener('DOMContentLoaded', () => {
            Game.init();
        });

        // Vis aktuelt klokkesl√¶t (realtid)
        setInterval(() => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('da-DK'); // Format: HH:MM:SS
            const clockDisplay = document.getElementById('realClockDisplay');
            if (clockDisplay) clockDisplay.textContent = `Klokken: ${timeString}`;
        }, 1000);


        // Lav nogle globale funktioner, som HTML kan kalde direkte
        function sendK√∏ret√∏jerTilAlarm(alarmIndex) {
            Game.sendSelectedVehiclesToAlarm(alarmIndex);
        }

        function selectVehicleForDispatch(stationIdx, vehicleIdx) {
            const vehicle = Game.stations[stationIdx].k√∏ret√∏jer[vehicleIdx];
            const index = Game.selectedVehicles.indexOf(vehicle);
            if (index > -1) Game.selectedVehicles.splice(index, 1);
            else Game.selectedVehicles.push(vehicle);
        }

        // --- Opdateret showStationDetails ---
        function showStationDetails(station) {
            const panel = document.getElementById("stationPanel");
            // If the same station is clicked again and panel is visible, hide it
            if (Game.selectedStation === station && panel.style.display === 'block') {
                panel.style.display = 'none';
                Game.selectedStation = null;
            } else {
                Game.selectedStation = station; // Set current selected station
                Game.hideAllPanels(); // Hide all other panels
                displayStationPanel(station, Game.stations); // Populate and display the station panel
                panel.style.display = 'block'; // Show the station panel
            }
        }
        // --- END Opdateret showStationDetails ---

        // --- RETTET: addVehicleToSelectedStation ---
        function addVehicleToSelectedStation() {
            if (Game.selectedStation) {
                // Kald addVehicleToStation funktionen direkte fra stationer.js
                // Denne funktion h√•ndterer selv prompts for navn og type.
                addVehicleToStation(Game.selectedStation, Game.map); 
                // Opdater visningen af stationens panel for at vise det nye k√∏ret√∏j
                displayStationPanel(Game.selectedStation, Game.stations); 
                // Opdater den globale statusoversigt
                Game.updateStatusPanels(); 
            }
        }
        // --- SLUT RETTELSE ---

        function deleteVehicleFromStation(stationIdx, vehicleIdx) {
            const station = Game.stations[stationIdx];
            deleteVehicle(station, vehicleIdx, Game.map); 
            displayStationPanel(station, Game.stations); 
            Game.updateStatusPanels(); // Update status after deleting vehicle
        }

        function editVehicleInStation(stationIdx, vehicleIdx) {
            alert("Redigeringsfunktion er ikke implementeret endnu.");
        }

        function deleteSelectedStation() {
            if (Game.selectedStation) {
                deleteStation(Game.selectedStation, Game.stations, Game.map); 
                Game.hideAllPanels(); 
                Game.selectedStation = null;
                Game.updateStatusPanels(); // Update status after deleting station
            }
        }

        function renameSelectedStation() {
            if (Game.selectedStation) {
                renameStation(Game.selectedStation); 
                displayStationPanel(Game.selectedStation, Game.stations); 
                Game.updateStatusPanels(); // Update status after renaming station
            }
        }

        // --- GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---
        function showSaveLoadPanel(mode) {
            Game.hideAllPanels(); // Hide other panels first
            const panel = document.getElementById('saveLoadPanel');
            const panelTitle = document.getElementById('panelTitle');
            const saveContent = document.getElementById('saveContent');
            const loadContent = document.getElementById('loadContent');
            
            panel.style.display = 'block';

            if (mode === 'save') {
                panelTitle.textContent = "Gem spil";
                saveContent.style.display = 'block';
                loadContent.style.display = 'none';
                document.getElementById('saveCodeOutput').value = generateSaveCode(Game); // Call save function
                document.getElementById('saveCodeOutput').select(); // Select text for easy copying
            } else if (mode === 'load') {
                panelTitle.textContent = "Indl√¶s spil";
                saveContent.style.display = 'none';
                loadContent.style.display = 'block';
                document.getElementById('loadCodeInput').value = ''; // Clear previous input
            }
        }

        function hideSaveLoadPanel() {
            document.getElementById('saveLoadPanel').style.display = 'none';
        }

        function copySaveCode() {
            const saveCodeOutput = document.getElementById('saveCodeOutput');
            saveCodeOutput.select();
            document.execCommand('copy');
            alert("Kode kopieret til udklipsholder!");
        }

        function loadGameAction() {
            const loadCodeInput = document.getElementById('loadCodeInput').value;
            if (loadCodeInput) {
                loadGameFromCode(loadCodeInput, Game, Game.map, updateVehicleMarkerIcon, createStationMarker, createVehicleMarker, clearAllMapElements);
                Game.updateStatusPanels(); // Update UI after loading
            } else {
                alert("Inds√¶t venligst en gemt kode.");
            }
        }
        // --- END GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---

        // --- ADDRESS SEARCH FUNCTIONS ---
        function handleAddressSearch(event) {
            if (event.key === 'Enter') {
                searchAddress();
            }
        }

        function searchAddress() {
            const query = document.getElementById('addressSearch').value.trim();
            if (!query) {
                alert('Indtast venligst en adresse at s√∏ge efter.');
                return;
            }

            // Use Nominatim (OpenStreetMap) geocoding service
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=dk&limit=5`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        showAddressResults(data, query);
                    } else {
                        alert(`Ingen adresser fundet for "${query}".`);
                    }
                })
                .catch(error => {
                    console.error('Address search error:', error);
                    alert('Fejl ved adresses√∏gning. Pr√∏v igen senere.');
                });
        }

        function showAddressResults(results, originalQuery) {
            if (results.length === 1) {
                // If only one result, go directly to it
                goToAddress(results[0]);
            } else {
                // Show selection dialog for multiple results
                let message = `Flere adresser fundet for "${originalQuery}":\n\n`;
                results.forEach((result, index) => {
                    message += `${index + 1}. ${result.display_name}\n`;
                });
                message += '\nV√¶lg nummer (1-' + results.length + '):';
                
                const choice = prompt(message);
                const choiceIndex = parseInt(choice) - 1;
                
                if (choiceIndex >= 0 && choiceIndex < results.length) {
                    goToAddress(results[choiceIndex]);
                } else if (choice !== null) {
                    alert('Ugyldigt valg.');
                }
            }
        }

        function goToAddress(addressData) {
            const lat = parseFloat(addressData.lat);
            const lng = parseFloat(addressData.lon);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Kunne ikke finde gyldig position for denne adresse.');
                return;
            }

            // Center map on the address
            Game.map.setView([lat, lng], 16);
            
            // Add a temporary marker to show the location
            const addressMarker = L.marker([lat, lng])
                .addTo(Game.map)
                .bindPopup(`üìç ${addressData.display_name}`)
                .openPopup();
            
            // Remove the marker after 10 seconds
            setTimeout(() => {
                Game.map.removeLayer(addressMarker);
            }, 10000);
            
            // Clear the search field
            document.getElementById('addressSearch').value = '';
        }
        // --- END ADDRESS SEARCH FUNCTIONS ---
    </script>
</body>
</html>