<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Vagtcentral Spil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        :root {
            --bg: #f5f5f5;
            --panel: #ffffff;
            --border: #ccc;
            --text: #222;
            --button-bg: #ffffff;
            --button-hover: #f0f0f0;
            --button-border: #ccc;
            --danger-button-bg: #f44336;
            --danger-button-hover: #d32f2f;
            --danger-button-text: white;
        }
        body.dark {
            --bg: #121212;
            --panel: #1e1e1e;
            --border: #444;
            --text: #f0f0f0;
            --button-bg: #2a2a2a;
            --button-hover: #333;
            --button-border: #555;
            --danger-button-bg: #cc2f2f;
            --danger-button-hover: #a02525;
            --danger-button-text: #f0f0f0;
        }
        #map {
            height: 90vh;
            width: 100%;
        }
        #controls {
            padding: 12px;
            background: var(--panel);
            color: var(--text);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1001;
            position: relative;
        }
        button, select {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover, select:hover {
            background: var(--button-hover);
        }
        .danger-button {
            background-color: var(--danger-button-bg);
            color: var(--danger-button-text);
            border-color: var(--danger-button-bg);
        }
        .danger-button:hover {
            background-color: var(--danger-button-hover);
        }

        #k√∏ret√∏jsPanel, #statusPanel, #logPanel, #stationPanel {
            position: absolute;
            top: 70px;
            left: 20px;
            background: var(--panel);
            padding: 14px;
            border-radius: 10px;
            max-height: 350px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: none;
            z-index: 1002;
            border: 1px solid var(--border);
            color: var(--text);
            min-width: 250px;
        }
        #stationPanel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--text);
        }
        #stationPanel .station-actions button {
            margin-bottom: 10px;
            width: 100%;
        }
        #stationPanel .vehicle-list div {
            padding: 5px 0;
            border-bottom: 1px dashed var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #stationPanel .vehicle-list div:last-child {
            border-bottom: none;
        }
        #stationPanel .vehicle-actions button {
            margin-left: 5px;
            padding: 4px 8px;
            font-size: 12px;
        }

        .station-ikon {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 10px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            color: var(--text);
            display: inline-block;
            white-space: nowrap;
        }
        .blink-lampe {
            width: 14px;
            height: 14px;
            background-color: red;
            border-radius: 50%;
            animation: blink 1s infinite;
            margin: auto;
            box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
        }
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px 2px rgba(255, 0, 0, 0.6);
            }
            50% {
                opacity: 0.2;
                box-shadow: 0 0 2px 1px rgba(255, 0, 0, 0.2);
            }
        }

        /* Styles for Save/Load Panel */
        #saveLoadPanel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--panel);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 10px;
            z-index: 2000; /* Higher z-index to be on top */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            color: var(--text);
            text-align: center;
        }
        #saveLoadPanel h2 {
            margin-top: 0;
            color: var(--text);
        }
        #saveLoadPanel textarea {
            width: calc(100% - 20px); /* Adjust width considering padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 5px;
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            resize: vertical; /* Allow vertical resizing */
        }
        #saveLoadPanel button {
            margin: 5px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="Game.activateStationMode()">‚ûï Tilf√∏j Station</button>
        <button onclick="Game.showVehicleSelectionPanel()">üö® Alarmer k√∏ret√∏j</button>
        <button onclick="Game.showStatusPanel()">üìã Status</button>
        <button onclick="Game.toggleStationsVisibility()">üè¢ Vis/Skjul stationer</button>
        <button onclick="Game.toggleTheme()">üåì Skift tema</button>
        <button onclick="showSaveLoadPanel('save')">üíæ Gem spil</button>
        <button onclick="showSaveLoadPanel('load')">üìÇ Indl√¶s spil</button>
        <label for="intervalV√¶lger">‚è±Ô∏è Alarm-interval:</label>
        <select id="intervalV√¶lger" onchange="Game.updateAlarmInterval()">
            <option value="60000">1 minut</option>
            <option value="120000" selected>2 minutter</option>
            <option value="300000">5 minutter</option>
            <option value="600000">10 minutter</option>
            <option value="5000">5 sekunder</option>
        </select>
    </div>
    <div id="map"></div>
    <div id="k√∏ret√∏jsPanel"></div>
    <div id="statusPanel"></div>
    <div id="logPanel"></div>
    <div id="stationPanel"></div>

    <div id="saveLoadPanel">
        <h2 id="panelTitle"></h2>
        <div id="saveContent">
            <p>Kopier koden herunder for at gemme dit spil:</p>
            <textarea id="saveCodeOutput" rows="8"></textarea>
            <button onclick="copySaveCode()">Kopier kode</button>
        </div>
        <div id="loadContent" style="display: none;">
            <p>Inds√¶t din gemte kode her:</p>
            <textarea id="loadCodeInput" rows="8"></textarea>
            <button onclick="loadGameAction()">Indl√¶s spil</button>
        </div>
        <button onclick="hideSaveLoadPanel()">Luk</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    
    <script src="map.js"></script>
    <script src="stationer.js"></script>
    <script src="alarmer.js"></script>
    <script src="save.js"></script>

    <script>
        // Hoved Game objekt for at orkestrere de forskellige moduler
        const Game = {
            map: null,
            stations: [],
            alarms: [],
            selectedVehicles: [],
            stationModeActive: false,
            selectedStation: null,
            alarmSound: new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg'),
            alarmTimer: null,
            missionLog: [],
            gameTime: 0, // Added gameTime to the Game object for saving/loading

            // Konstanter for animation
            REFRESH_INTERVAL_MS: 300,
            STANDARD_TRAVEL_TIME_SECONDS: 1700,
            
            // New setting for alarm spawn radius (in kilometers)
            ALARM_SPAWN_RADIUS_KM: 10, // Default to 10km for now

            init: function() {
                this.map = initMap(); 
                
                if (localStorage.getItem("tema") === "dark") {
                    document.body.classList.add("dark");
                }

                this.updateAlarmInterval();

                this.map.on('click', (e) => {
                    if (!this.stationModeActive) return;
                    addStationToMap(e.latlng); 
                    this.stationModeActive = false;
                });
                
                // Add an event listener for the 'beforeunload' event to prompt the user to save
                window.addEventListener('beforeunload', (event) => {
                    // Standard browser message (modern browsers often ignore custom messages for security)
                    event.preventDefault(); 
                    event.returnValue = ''; // Required for some browsers to show the prompt
                });
            },

            activateStationMode: function() {
                if (this.stationModeActive) { 
                    this.stationModeActive = false; 
                    alert("Tilf√∏j station annulleret."); 
                } else {
                    this.stationModeActive = true; 
                    this.hideAllPanels(); 
                    alert("Klik p√• kortet for at placere en station.");
                }
            },

            showVehicleSelectionPanel: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    displayVehicleSelectionPanel(this.stations); 
                }
            },

            showStatusPanel: function() {
                const panel = document.getElementById("statusPanel");
                if (panel.style.display === 'block') { 
                    panel.style.display = 'none'; 
                } else {
                    this.hideAllPanels(); 
                    displayStatusPanel(this.stations); 
                }
            },

            toggleStationsVisibility: function() {
                toggleStationMarkers(this.stations); 
            },

            toggleTheme: function() {
                document.body.classList.toggle("dark");
                localStorage.setItem("tema", document.body.classList.contains("dark") ? "dark" : "light");
            },

            updateAlarmInterval: function() {
                const ms = parseInt(document.getElementById("intervalV√¶lger").value);
                if (this.alarmTimer) clearInterval(this.alarmTimer);
                this.alarmTimer = setInterval(() => {
                    // Pass the ALARM_SPAWN_RADIUS_KM from Game object
                    createAlarm(this.stations, this.alarms, this.alarmSound, this.ALARM_SPAWN_RADIUS_KM); 
                }, ms);
            },
            
            sendSelectedVehiclesToAlarm: function(alarmIndex) {
                const alarm = this.alarms[alarmIndex];
                if (!alarm) return;
                
                sendVehiclesToAlarm(
                    alarm, 
                    this.selectedVehicles, 
                    this.map, 
                    this.REFRESH_INTERVAL_MS, 
                    this.STANDARD_TRAVEL_TIME_SECONDS, 
                    this.stations, 
                    this.alarms, 
                    this.missionLog
                );
                this.selectedVehicles = []; 
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
            },

            chooseAlarmAndDispatch: function() {
                const panel = document.getElementById("k√∏ret√∏jsPanel");
                panel.innerHTML = "<b>V√¶lg alarm til at sende k√∏ret√∏jerne til:</b><br>";
                if (this.alarms.length === 0) { 
                    panel.innerHTML += "Ingen aktive alarmer.";
                    return;
                }
                this.alarms.forEach((alarm, idx) => { 
                    panel.innerHTML += `<button onclick='sendK√∏ret√∏jerTilAlarm(${idx})'>#${alarm.id} - ${alarm.type}</button><br>`;
                });
            },
            
            hideAllPanels: function() {
                document.getElementById("stationPanel").style.display = 'none';
                document.getElementById("k√∏ret√∏jsPanel").style.display = 'none';
                document.getElementById("statusPanel").style.display = 'none';
                document.getElementById("logPanel").style.display = 'none'; 
                document.getElementById("saveLoadPanel").style.display = 'none'; // Also hide the save/load panel
            }
        };

        // K√∏r initialiseringsfunktionen n√•r DOM er indl√¶st
        document.addEventListener('DOMContentLoaded', () => {
            Game.init();
        });

        // Lav nogle globale funktioner, som HTML kan kalde direkte
        function sendK√∏ret√∏jerTilAlarm(alarmIndex) {
            Game.sendSelectedVehiclesToAlarm(alarmIndex);
        }

        function selectVehicleForDispatch(stationIdx, vehicleIdx) {
            const vehicle = Game.stations[stationIdx].k√∏ret√∏jer[vehicleIdx];
            const index = Game.selectedVehicles.indexOf(vehicle);
            if (index > -1) Game.selectedVehicles.splice(index, 1);
            else Game.selectedVehicles.push(vehicle);
        }

        function showStationDetails(station) {
            const panel = document.getElementById("stationPanel");
            if (Game.selectedStation === station && panel.style.display === 'block') {
                panel.style.display = 'none';
                Game.selectedStation = null;
            } else {
                Game.selectedStation = station;
                Game.hideAllPanels();
                displayStationPanel(station, Game.stations);
                panel.style.display = 'block';
            }
        }

        function addVehicleToSelectedStation() {
            if (Game.selectedStation) {
                addVehicleToStation(Game.selectedStation, Game.map); 
                displayStationPanel(Game.selectedStation, Game.stations); 
            }
        }

        function deleteVehicleFromStation(stationIdx, vehicleIdx) {
            const station = Game.stations[stationIdx];
            deleteVehicle(station, vehicleIdx, Game.map); 
            displayStationPanel(station, Game.stations); 
        }

        function editVehicleInStation(stationIdx, vehicleIdx) {
            alert("Redigeringsfunktion er ikke implementeret endnu.");
        }

        function deleteSelectedStation() {
            if (Game.selectedStation) {
                deleteStation(Game.selectedStation, Game.stations, Game.map); 
                Game.hideAllPanels(); 
                Game.selectedStation = null;
            }
        }

        function renameSelectedStation() {
            if (Game.selectedStation) {
                renameStation(Game.selectedStation); 
                displayStationPanel(Game.selectedStation, Game.stations); 
            }
        }

        // --- GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---
        function showSaveLoadPanel(mode) {
            Game.hideAllPanels(); // Hide other panels first
            const panel = document.getElementById('saveLoadPanel');
            const panelTitle = document.getElementById('panelTitle');
            const saveContent = document.getElementById('saveContent');
            const loadContent = document.getElementById('loadContent');
            
            panel.style.display = 'block';

            if (mode === 'save') {
                panelTitle.textContent = "Gem spil";
                saveContent.style.display = 'block';
                loadContent.style.display = 'none';
                document.getElementById('saveCodeOutput').value = generateSaveCode(Game); // Call save function
                document.getElementById('saveCodeOutput').select(); // Select text for easy copying
            } else if (mode === 'load') {
                panelTitle.textContent = "Indl√¶s spil";
                saveContent.style.display = 'none';
                loadContent.style.display = 'block';
                document.getElementById('loadCodeInput').value = ''; // Clear previous input
            }
        }

        function hideSaveLoadPanel() {
            document.getElementById('saveLoadPanel').style.display = 'none';
        }

        function copySaveCode() {
            const saveCodeOutput = document.getElementById('saveCodeOutput');
            saveCodeOutput.select();
            document.execCommand('copy');
            alert("Kode kopieret til udklipsholder!");
        }

        function loadGameAction() {
            const loadCodeInput = document.getElementById('loadCodeInput').value;
            if (loadCodeInput) {
                // Pass all necessary dependencies to loadGameFromCode
                // Ensure these functions are globally accessible or passed correctly from map.js
                loadGameFromCode(loadCodeInput, Game, Game.map, updateVehicleMarkerIcon, createStationMarker, createVehicleMarker, clearAllMapElements);
            } else {
                alert("Inds√¶t venligst en gemt kode.");
            }
        }
        // --- END GLOBAL FUNCTIONS FOR SAVE/LOAD PANEL ---
    </script>
</body>
</html>